<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Casey Breen, Jiaxuan Li, Ridhi Kashyap">
<meta name="dcterms.date" content="2025-07-03">

<title>Tutorial 2: Nowcasting National and Subnational Digital Gender Gaps</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="tutorial2_prediction_files/libs/clipboard/clipboard.min.js"></script>
<script src="tutorial2_prediction_files/libs/quarto-html/quarto.js"></script>
<script src="tutorial2_prediction_files/libs/quarto-html/popper.min.js"></script>
<script src="tutorial2_prediction_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="tutorial2_prediction_files/libs/quarto-html/anchor.min.js"></script>
<link href="tutorial2_prediction_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="tutorial2_prediction_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="tutorial2_prediction_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="tutorial2_prediction_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="tutorial2_prediction_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Tutorial 2: Nowcasting National and Subnational Digital Gender Gaps</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Casey Breen, Jiaxuan Li, Ridhi Kashyap </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">July 3, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="nowcasting-national-and-subnational-digital-gender-gaps" class="level1">
<h1>Nowcasting National and Subnational Digital Gender Gaps</h1>
<p>In this section, we will cover the steps of fitting and assessing supervised machine learning algorithms to predict digital gender gaps at national and subnational level. Specifically, we will fit a linear regression model to predict national gender gap and a random forest model for subnational gender gap. We will also introduce sample splitting and cross-validation design, and model performance metrics.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="do">## library package </span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)     <span class="do">## tidyverse </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'ggplot2' was built under R version 4.4.1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'tibble' was built under R version 4.4.1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'purrr' was built under R version 4.4.1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'lubridate' was built under R version 4.4.1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
✔ dplyr     1.1.4     ✔ readr     2.1.5
✔ forcats   1.0.0     ✔ stringr   1.5.1
✔ ggplot2   3.5.2     ✔ tibble    3.3.0
✔ lubridate 1.9.4     ✔ tidyr     1.3.1
✔ purrr     1.0.4     
── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()
ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)    <span class="do">## machine learning package </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching packages ────────────────────────────────────── tidymodels 1.2.0 ──
✔ broom        1.0.5     ✔ rsample      1.2.1
✔ dials        1.3.0     ✔ tune         1.2.1
✔ infer        1.0.7     ✔ workflows    1.1.4
✔ modeldata    1.4.0     ✔ workflowsets 1.1.0
✔ parsnip      1.2.1     ✔ yardstick    1.3.2
✔ recipes      1.3.1     </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'scales' was built under R version 4.4.1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'recipes' was built under R version 4.4.1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'yardstick' was built under R version 4.4.1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Conflicts ───────────────────────────────────────── tidymodels_conflicts() ──
✖ scales::discard() masks purrr::discard()
✖ dplyr::filter()   masks stats::filter()
✖ recipes::fixed()  masks stringr::fixed()
✖ dplyr::lag()      masks stats::lag()
✖ yardstick::spec() masks readr::spec()
✖ recipes::step()   masks stats::step()
• Learn how to get started at https://www.tidymodels.org/start/</code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cowplot)       <span class="do">## pretty plots </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'cowplot'

The following object is masked from 'package:lubridate':

    stamp</code></pre>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ranger)        <span class="do">## ranger </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'ranger' was built under R version 4.4.1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(remotes)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cli)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'cli' was built under R version 4.4.1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages("remotes")</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages("cli", dependencies = TRUE)</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co">#remotes::install_github("r-lib/cli")</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="do">## set seed for reproducibility </span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">47</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="predicting-national-level-female-internet-adoption-using-ordinary-least-squares-ols-regression-model" class="level2">
<h2 class="anchored" data-anchor-id="predicting-national-level-female-internet-adoption-using-ordinary-least-squares-ols-regression-model">1. Predicting National-level Female Internet Adoption Using Ordinary Least Squares (OLS) Regression Model</h2>
<p>In the first part of this tutorial, we will train and evaluate an OLS model to predict internet adoption among women aged 15–49 at the national level. We employ a simple model because our ground truth consists of only 71 data points. Using more complex machine learning models, such as random forests, would likely lead to overfitting — the model might perform well on the training data but fail to generalize reliably to other countries or regions.</p>
<p>Our dataset includes two kinds of national features:</p>
<ul>
<li><p>“Online” features: The monthly active user (MAU) counts of men and women on Facebook</p></li>
<li><p>“Offline” features: A set of socioeconomic indicators from various sources</p></li>
</ul>
<p>Let’s read in the master file</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>national_masterfile <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"national_masterfile.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 72 Columns: 15
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr  (1): iso3
dbl (14): fb_18_999_men, fb_18_999_wom, fb_18_999_r, hdi, gdi, gdp_pcap, yea...

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>national_masterfile <span class="ot">&lt;-</span> <span class="fu">drop_na</span>(national_masterfile)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="feature-definitions" class="level3">
<h3 class="anchored" data-anchor-id="feature-definitions">1.1 Feature Definitions</h3>
<p>The dataset we are using here was created by the Digital Gender Gaps team by assembling data from various sources. Here’s the descriptions of the features we have available in our dataset:</p>
<ul>
<li><code>iso3</code>: Three-letter country identifier defined by the ISO 3166-1 standard</li>
<li><code>internet_men</code>: Percentage of men (ages 15–49) who used the internet in the past 12 months, weighted (From Demographic and Health Survey (DHS) and Multiple Indicator Cluster Survey (MICS) data)</li>
<li><code>internet_wom</code>: Percentage of women (ages 15–49) who used the internet in the past 12 months, weighted (From DHS and MICS data)</li>
<li><code>internet_ggi</code>: Female-to-male ratio of internet usage among individuals aged 15–49, weighted (From DHS and MICS data)</li>
<li><code>fb_18_999_wom</code>: Facebook penetration rate among women aged 18+ (percentage of women on Facebook in the last month relative to population) (from FB marketing API)</li>
<li><code>fb_18_999_men</code>: Facebook penetration rate among men aged 18+ (percentage of women on Facebook in the last month relative to population) (from FB marketing API)</li>
<li><code>fb_18_999_r</code>: Female-to-male ratio of Facebook penetration rate (from FB marketing API)</li>
<li><code>hdi</code>: National-level composite measure of health, education, and standard of living (from <a href="https://hdr.undp.org/data-center/documentation-and-downloads">UNDP</a>)</li>
<li><code>gdi</code>: National-level Gender Development Index (GDI), measuring disparities on the HDI by gender (from <a href="https://hdr.undp.org/data-center/documentation-and-downloads">UNDP</a>)</li>
<li><code>gdp_pcap</code>: GDP per capita (from <a href="https://data.worldbank.org/indicator/NY.GDP.PCAP.CD?view=chart">World Bank</a>)</li>
<li><code>gggi_ggi</code>: Overall gender gap in four fundamental categories: Economic Participation and Opportunity, Educational Attainment, Health and Survival and Political Empowerment. (from <a href="https://datafinder.qog.gu.se/dataset/gggi">World Economic Forum</a>)</li>
<li><code>coef_ineq</code>: Coefficient of human inequality (from <a href="https://hdr.undp.org/data-center/documentation-and-downloads">UNDP</a>)</li>
<li><code>mys_r</code>: Mean years of schooling, female:male ratio (from <a href="https://hdr.undp.org/data-center/documentation-and-downloads">UNDP</a>)</li>
<li><code>lfpr_r</code>: Labor force participation rates (%), female:male ratio (from <a href="https://hdr.undp.org/data-center/documentation-and-downloads">UNDP</a>)</li>
</ul>
</section>
<section id="sample-splitting" class="level3">
<h3 class="anchored" data-anchor-id="sample-splitting">1.2 Sample splitting</h3>
<p>In machine learning, sample splitting is a key step to ensure that models generalize well to unseen data. The simplest sample splitting is a test-train split:</p>
<ul>
<li><p>The training set is used to fit the model</p></li>
<li><p>The testing set evaluates how well the model performs on unseen data</p></li>
</ul>
<p>This helps prevent overfitting, where a model performs well on training data but poorly on new data.</p>
<p>To split the sample, we can use the <code>initial_split()</code> function from the <code>rsample</code> package. The <code>rsample</code> package is part of the <code>tidymodels</code> framework.</p>
<p>This function will automatically randomly split the data into a training partition and a test partition according to the proportions we provide as an argument to the function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co">#set.seed(47)</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="do">## split into two folds (partitions)</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>national_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(national_masterfile, <span class="at">prop =</span> .<span class="dv">75</span>)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="do">## split into a train-test sample </span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>national_train <span class="ot">&lt;-</span> <span class="fu">training</span>(national_split) </span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>national_test <span class="ot">&lt;-</span> <span class="fu">testing</span>(national_split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="simple-ordinary-least-squares-ols-regression-model" class="level3">
<h3 class="anchored" data-anchor-id="simple-ordinary-least-squares-ols-regression-model">1.3 Simple Ordinary Least Squares (OLS) Regression Model</h3>
<p>First, we’ll try fitting an OLS regression model (linear regression). We use OLS in the national pipeline due to a small sample size. However, even if the sample size allows more complex modelling, OLS models are still a good starting place for the modeling process. They are easy to interpret and can also serve as a helpful benchmark to help you understand how much better more complex machine learning algorithms are doing than a simple model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit models using some randomly picked features</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>national_primary <span class="ot">&lt;-</span> <span class="fu">lm</span>(internet_wom <span class="sc">~</span> fb_18_999_wom <span class="sc">+</span> hdi <span class="sc">+</span> gdi <span class="sc">+</span> gdp_pcap, <span class="at">data =</span> national_train)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="do">## print out summary of linear model </span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(national_primary)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = internet_wom ~ fb_18_999_wom + hdi + gdi + gdp_pcap, 
    data = national_train)

Residuals:
     Min       1Q   Median       3Q      Max 
-0.26204 -0.08464 -0.00277  0.06938  0.39539 

Coefficients:
              Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)   -0.86286    0.39036  -2.210   0.0319 *  
fb_18_999_wom  0.45317    0.09504   4.768 1.77e-05 ***
hdi            0.30293    0.50012   0.606   0.5476    
gdi            0.74513    0.41805   1.782   0.0810 .  
gdp_pcap       0.02085    0.04440   0.470   0.6407    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.1241 on 48 degrees of freedom
Multiple R-squared:  0.735, Adjusted R-squared:  0.7129 
F-statistic: 33.28 on 4 and 48 DF,  p-value: 2.691e-13</code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict on the test datasets</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>predicted_internet_wom <span class="ot">&lt;-</span> <span class="fu">predict</span>(national_primary, national_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="model-performance-evaluation" class="level3">
<h3 class="anchored" data-anchor-id="model-performance-evaluation">1.4 Model Performance Evaluation</h3>
<p>Let’s first visualize our errors in a calibration plot, which allows us to directly compare the predicted vs.&nbsp;actual values and analyze residuals.This helps us intuitively assess how well the model performs.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="do">## add predictions onto test (hold-out) data and limit prediction to (0, 1), since the penetration rate cannot be smaller than 0 or greater than 1</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>predicted_internet_wom <span class="ot">&lt;-</span> <span class="fu">pmin</span>(<span class="fu">pmax</span>(predicted_internet_wom, <span class="dv">0</span>), <span class="dv">1</span>)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>national_test_predict <span class="ot">&lt;-</span> national_test <span class="sc">%&gt;%</span> </span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">predicted_internet_wom =</span> predicted_internet_wom)</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>national_test_predict <span class="sc">%&gt;%</span> </span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> predicted_internet_wom, <span class="at">y =</span> internet_wom)) <span class="sc">+</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_cowplot</span>() <span class="sc">+</span> </span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlim</span>(<span class="dv">0</span>, <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="tutorial2_prediction_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>If our predictions were perfect, they would lie along the red dashed line at 45 degrees. Here, we see some degrees of deviations away from this line, but the prediction still looks good.</p>
<p>To more formally assess the performance of our model, we’ll calculate the three error metrics: Mean Absolute Error, Root Mean Squared Error, and R-squared. We’ll introduce them below and then write functions to calculate these error metrics.</p>
<section id="mean-absolute-error-mae" class="level4">
<h4 class="anchored" data-anchor-id="mean-absolute-error-mae">1.4.1 Mean Absolute Error (MAE)</h4>
<p>MAE measures the average absolute differences between actual and predicted values:</p>
<p><span class="math display">\[
\text{MAE} = \frac{1}{n} \sum_{i=1}^{n} |y_i - \hat{y}_i|
\]</span></p>
<p>It provides an intuitive measure of the magnitude of error, treating all deviations equally.</p>
</section>
<section id="root-mean-squared-error-rmse" class="level4">
<h4 class="anchored" data-anchor-id="root-mean-squared-error-rmse">1.4.2 Root Mean Squared Error (RMSE)</h4>
<p>RMSE squares the errors before averaging, making it more sensitive to large deviations. It then takes the square root of the mean squared errors to bring the error units back to the original scale of the dependent variable, making it easier to interpret compared to Mean Squared Error (MSE):</p>
<p><span class="math display">\[
\text{RMSE} = \sqrt{\frac{1}{n} \sum_{i=1}^{n} (y_i - \hat{y}_i)^2}
\]</span></p>
<p>This metric is widely used and penalizes large errors more than smaller ones.</p>
</section>
<section id="r-squared-r2" class="level4">
<h4 class="anchored" data-anchor-id="r-squared-r2">1.4.3 R-squared (<span class="math inline">\(R^2\)</span>)</h4>
<p><span class="math inline">\(R^2\)</span> quantifies how well the model explains variance in the dependent variable:</p>
<p><span class="math display">\[
R^2 = 1 - \frac{\sum_{i=1}^{n} (y_i - \hat{y}_i)^2}{\sum_{i=1}^{n} (y_i - \bar{y})^2}
\]</span></p>
<p>where <span class="math inline">\(\bar{y}\)</span> is the mean of the observed values. Higher values indicate a better fit, with <span class="math inline">\(R^2 = 1\)</span> representing a perfect model and <span class="math inline">\(R^2 = 0\)</span> representing a model doing no better than predicting mean of outcome variable.</p>
</section>
<section id="calculate-model-performance-metrics" class="level4">
<h4 class="anchored" data-anchor-id="calculate-model-performance-metrics">1.4.4 Calculate model performance metrics</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to compute Mean Absolute Error (MAE)</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>mae <span class="ot">&lt;-</span> <span class="cf">function</span>(actual, predicted) {</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>(<span class="fu">abs</span>(actual <span class="sc">-</span> predicted))</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to compute Root Mean Squared Error (MSE)</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>rmse <span class="ot">&lt;-</span> <span class="cf">function</span>(actual, predicted) {</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sqrt</span>(<span class="fu">mean</span>((actual <span class="sc">-</span> predicted)<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to compute R-squared (R²)</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>r_squared <span class="ot">&lt;-</span> <span class="cf">function</span>(actual, predicted) {</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>  ss_total <span class="ot">&lt;-</span> <span class="fu">sum</span>((actual <span class="sc">-</span> <span class="fu">mean</span>(actual))<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>  ss_residual <span class="ot">&lt;-</span> <span class="fu">sum</span>((actual <span class="sc">-</span> predicted)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span> <span class="sc">-</span> (ss_residual <span class="sc">/</span> ss_total)</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s use the functions we just created to calculate model performance metrics for our linear model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Calculate mae, mse, and r_squared </span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>national_test_predict <span class="sc">%&gt;%</span> </span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">rmse =</span> <span class="fu">rmse</span>(internet_wom, predicted_internet_wom),</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">mae =</span> <span class="fu">mae</span>(internet_wom, predicted_internet_wom),</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">r_squared =</span> <span class="fu">r_squared</span>(internet_wom, predicted_internet_wom))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
   rmse   mae r_squared
  &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;
1 0.153 0.132     0.756</code></pre>
</div>
</div>
<p>The model is doing moderately well — the <span class="math inline">\(R^2\)</span> value tells us that 76% of the variance is explained by the model. On average, our model predictions for female internet penetration rate deviate from the actual observed values for 0.13.</p>
</section>
</section>
<section id="cross-validation" class="level3">
<h3 class="anchored" data-anchor-id="cross-validation">1.5 Cross-validation</h3>
<p>In traditional train-test splitting, a common limitation is that not all data points are used for both training and testing — this can lead to less efficient/reliable model evaluations. Cross-validation addresses this by ensuring that each observation is used in both training and validation phases, providing a more comprehensive assessment of the model’s performance.</p>
<p>The most common method is k-fold cross-validation, where the data is split into k parts (folds). The model is trained on k-1 folds and tested on the remaining fold. This process repeats k times, with each fold used for testing once. The results are averaged to the overall performance metric.</p>
<p>That’s what we’ll do here. To perform the cross-validation, we’ll use the <code>tidymodel</code> <a href="https://www.tidymodels.org/">package</a>. This is a well-maintained modern framework in R for streamlining machine learning workflows. First, we’ll use the <code>vfold_cv</code> function to randomly split our dataset into 10 separate folds. For k-fold cross-validation, 10 is a fairly standard choice for the number of folds—but there may be settings where want to use a different number of folds.</p>
<p>We’ll use our full dataset (we are using cross-validation instead of doing a test/train split).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">47</span>)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="do">## create folds </span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>folds_10folds <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(national_masterfile, <span class="at">v =</span> <span class="dv">10</span>)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>folds_10folds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#  10-fold cross-validation 
# A tibble: 10 × 2
   splits         id    
   &lt;list&gt;         &lt;chr&gt; 
 1 &lt;split [63/8]&gt; Fold01
 2 &lt;split [64/7]&gt; Fold02
 3 &lt;split [64/7]&gt; Fold03
 4 &lt;split [64/7]&gt; Fold04
 5 &lt;split [64/7]&gt; Fold05
 6 &lt;split [64/7]&gt; Fold06
 7 &lt;split [64/7]&gt; Fold07
 8 &lt;split [64/7]&gt; Fold08
 9 &lt;split [64/7]&gt; Fold09
10 &lt;split [64/7]&gt; Fold10</code></pre>
</div>
</div>
<p>In <code>tidymodels</code>, we use a <strong>workflow</strong> to organize the different components of our modeling process—such as the model definition and the formula that specifies the outcome and predictors. After we’ve defined our model, we can pass the specification to the key function we want to use for cross-validation, which is <code>fit_resamples()</code>. The function will fit the model to multiple subsets of the data and assesses its performance on corresponding test sets.</p>
<p>We’ll also have the function automatically calculate the three model performance metrics we’re interested in. We will need to manually specify the error metrics in the <code>fit_resamples()</code> function from the <code>yardstick</code> package. We’ll use mean absolute error (MAE), root mean squared error (RMSE), and <span class="math inline">\(R^2\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="do">##Set up ols model specification</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>ols_spec <span class="ot">&lt;-</span> <span class="fu">linear_reg</span>() <span class="sc">%&gt;%</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"lm"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>ols_res_10fold <span class="ot">&lt;-</span> <span class="fu">fit_resamples</span>(</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>  ols_spec,</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>  internet_wom <span class="sc">~</span> fb_18_999_wom <span class="sc">+</span> hdi <span class="sc">+</span> gdi <span class="sc">+</span> gdp_pcap,</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">resamples =</span> folds_10folds,</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">metrics =</span> <span class="fu">metric_set</span>(yardstick<span class="sc">::</span>rmse, yardstick<span class="sc">::</span>mae, yardstick<span class="sc">::</span>rsq)</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To access the error metric that were calculated by the <code>fit_resamples()</code> function, we can use the <code>collect_metrics()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="do">## get error metrics  </span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>error_metrics_10fold_national <span class="ot">&lt;-</span> <span class="fu">collect_metrics</span>(ols_res_10fold)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="do">## print out error metrics </span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>error_metrics_10fold_national <span class="sc">%&gt;%</span> </span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cv_method =</span> <span class="st">"10-fold"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 7
  .metric .estimator   mean     n std_err .config              cv_method
  &lt;chr&gt;   &lt;chr&gt;       &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;                &lt;chr&gt;    
1 mae     standard   0.0999    10 0.00778 Preprocessor1_Model1 10-fold  
2 rmse    standard   0.124     10 0.0106  Preprocessor1_Model1 10-fold  
3 rsq     standard   0.721     10 0.0703  Preprocessor1_Model1 10-fold  </code></pre>
</div>
</div>
<p>Here, we’re interested in the mean of the performance error metrics across the 10 different folds. Our model appears to be performing well. It explains 72% of the variation in female internet adoption.</p>
</section>
<section id="model-comparison-online-offline-and-combined" class="level3">
<h3 class="anchored" data-anchor-id="model-comparison-online-offline-and-combined">1.6 Model Comparison: Online, Offline and Combined</h3>
<p>We categorize our predicting models into three types based on the features they use. Online models include only Facebook features, while offline models use only background socioeconomic indicators. Combined models include both types of features. To compare the performance of these models, we’ll once again use cross-validation along with performance metrics that we defined above.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="do">##Online model, including all fb features. We continue to use the specification for OLS model defined above.</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>ols_res_10fold_online <span class="ot">&lt;-</span> <span class="fu">fit_resamples</span>(</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  ols_spec,</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>  internet_wom <span class="sc">~</span> fb_18_999_wom <span class="sc">+</span> fb_18_999_wom <span class="sc">+</span> fb_18_999_r,</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">resamples =</span> folds_10folds,</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">metrics =</span> <span class="fu">metric_set</span>(yardstick<span class="sc">::</span>rmse, yardstick<span class="sc">::</span>mae, yardstick<span class="sc">::</span>rsq)</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>error_metrics_10fold_national_online <span class="ot">&lt;-</span> <span class="fu">collect_metrics</span>(ols_res_10fold_online) <span class="sc">%&gt;%</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">model_type =</span> <span class="st">"online"</span>)</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a><span class="do">##Offline model, including only a set of background features</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>ols_res_10fold_offline <span class="ot">&lt;-</span> <span class="fu">fit_resamples</span>(</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>  ols_spec,</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>  internet_wom <span class="sc">~</span> hdi <span class="sc">+</span> gdi <span class="sc">+</span> gdp_pcap <span class="sc">+</span> years_from_2015,</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">resamples =</span> folds_10folds,</span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">metrics =</span> <span class="fu">metric_set</span>(yardstick<span class="sc">::</span>rmse, yardstick<span class="sc">::</span>mae, yardstick<span class="sc">::</span>rsq)</span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>) </span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>error_metrics_10fold_national_offline <span class="ot">&lt;-</span> <span class="fu">collect_metrics</span>(ols_res_10fold_offline) <span class="sc">%&gt;%</span></span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">model_type =</span> <span class="st">"offline"</span>)</span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a><span class="do">##Combined model, using combined feature sets</span></span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a>ols_res_10fold_combined <span class="ot">&lt;-</span> <span class="fu">fit_resamples</span>(</span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a>  ols_spec,</span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a>  internet_wom <span class="sc">~</span> fb_18_999_wom <span class="sc">+</span> fb_18_999_wom <span class="sc">+</span> fb_18_999_r <span class="sc">+</span> hdi <span class="sc">+</span> gdi <span class="sc">+</span> gdp_pcap <span class="sc">+</span> years_from_2015,</span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">resamples =</span> folds_10folds,</span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">metrics =</span> <span class="fu">metric_set</span>(yardstick<span class="sc">::</span>rmse, yardstick<span class="sc">::</span>mae, yardstick<span class="sc">::</span>rsq)</span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">model_type =</span> <span class="st">"combined"</span>)</span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-32"><a href="#cb36-32" aria-hidden="true" tabindex="-1"></a>error_metrics_10fold_national_combined <span class="ot">&lt;-</span> <span class="fu">collect_metrics</span>(ols_res_10fold_combined) <span class="sc">%&gt;%</span></span>
<span id="cb36-33"><a href="#cb36-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">model_type =</span> <span class="st">"combined"</span>)</span>
<span id="cb36-34"><a href="#cb36-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-35"><a href="#cb36-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-36"><a href="#cb36-36" aria-hidden="true" tabindex="-1"></a><span class="do">##Combining error metrics together</span></span>
<span id="cb36-37"><a href="#cb36-37" aria-hidden="true" tabindex="-1"></a>national_model_comparison <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(error_metrics_10fold_national_online, error_metrics_10fold_national_offline, error_metrics_10fold_national_combined)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Visualize our results using bar charts</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(national_model_comparison, <span class="fu">aes</span>(<span class="at">x =</span> model_type, <span class="at">y =</span> mean, <span class="at">fill =</span> model_type)) <span class="sc">+</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">width =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">round</span>(mean, <span class="dv">3</span>)), </span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">vjust =</span> <span class="dv">1</span>, <span class="at">size =</span> <span class="fl">3.5</span>) <span class="sc">+</span> </span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> .metric, <span class="at">scales =</span> <span class="st">"free_y"</span>, <span class="at">ncol =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_cowplot</span>() <span class="sc">+</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="tutorial2_prediction_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The 10-fold cross-validation results across all performance metrics consistently indicate that the combined model outperforms both the online and offline models. From a theoretical perspective, this is expected: combining online and offline features should yield more precise estimates of the digital gender gap. While online indicators such as Facebook penetration can serve as useful proxies, they are susceptible to <strong>behavioral drift</strong>—that is, changes in platform usage patterns across countries and over time. For example, in countries with mature internet markets, younger female users may prefer Instagram over Facebook. In contrast, in countries with emerging digital infrastructure, Facebook may remain the dominant platform across age and gender groups. As a result, the same Facebook gender gap value (e.g., 0.85) may have very different implications in the UK versus Indonesia. We therefore include offline indicators to help contextualize and correct for these behavioral differences across different settings.</p>
</section>
<section id="exercise-1" class="level3">
<h3 class="anchored" data-anchor-id="exercise-1">1.7 Exercise 1:</h3>
<ol type="1">
<li>Can we improve our model performance by adding more predictors into the model? Set up a new model on the basis of the combined model and compare their MAE, RMSE, and <span class="math inline">\(R^2\)</span>. What would be the potential drawbacks of adding more features?</li>
<li>Try setting up a combined model to predict internet gender gap (<code>internet_ggi</code>). Compare its performance to the model predicting female internet adoption (<code>internet_wom</code>). Does the model perform better or worse when predicting the gender gap? What might explain the difference in model performance between these two outcomes?</li>
</ol>
</section>
</section>
<section id="predicting-subnational-level-female-internet-adoption-using-random-forest" class="level2">
<h2 class="anchored" data-anchor-id="predicting-subnational-level-female-internet-adoption-using-random-forest">2. Predicting Subnational-level Female Internet Adoption Using Random Forest</h2>
<p>National-level nowcasts of the digital gender gap have provided valuable insights into global patterns of digital gender inequality. However, many countries exhibit significant internal geographic disparities, which can lead to substantial subnational variation in digital gender gaps. To capture these within-country differences, we calculated ground truth data at the GADM1 (first-level administrative) level from Demographic and Health Surveys (DHS) and trained machine learning models to predict digital gender gaps at the subnational scale. The subnational analysis yields a larger “sample size” (one country could split into 10 regions) that enables us to adopt more complex machine learning models. Here, we introduce predicting subnational digital gender gaps using Random Forest models.</p>
<p>Let’s first read in the data</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>internet_subnational <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"subnational_masterfile.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 570 Columns: 14
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr  (2): gid_1, country
dbl (12): perc_used_internet_past12months_wght_age_15_to_49_wom, perc_used_i...

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
</div>
<section id="feature-definitions-1" class="level3">
<h3 class="anchored" data-anchor-id="feature-definitions-1">2.1 Feature Definitions</h3>
<p>Our subnational feature sets also consist of both online and offline fatures. Here’s the descriptions of the features we have available in our dataset:</p>
<ul>
<li><code>gid_1</code>: Subnational administrative unit identifier (from GADM, a global administrative boundaries database).</li>
<li><code>country</code>: Name of the country corresponding to the administrative unit.</li>
<li><code>perc_used_internet_past12months_wght_age_15_to_49_wom</code>: Percentage of women (ages 15–49) who used the internet in the past 12 months, weighted (from DHS)</li>
<li><code>perc_used_internet_past12months_wght_age_15_to_49_fm_ratio</code>: Female-to-male ratio of internet usage among individuals aged 15–49, weighted (from DHS)</li>
<li><code>hdi_national</code>: National-level composite measure of health, education, and standard of living (from <a href="https://hdr.undp.org/data-center/documentation-and-downloads">UNDP</a>)</li>
<li><code>gdi_national</code>: National-level Gender Development Index (GDI), measuring disparities on the HDI by gender (from <a href="https://hdr.undp.org/data-center/documentation-and-downloads">UNDP</a>)</li>
<li><code>subnational_gdi</code>: Subnational-level Gender Development Index (from <a href="https://globaldatalab.org/shdi/">Global Development Lab</a>)</li>
<li><code>subnational_hdi_females</code>: Subnational composite measure of health, education, and standard of living for women (from <a href="https://globaldatalab.org/shdi/">Global Development Lab</a>)</li>
<li><code>subnational_hdi_males</code>: Subnational composite measure of health, education, and standard of living for men (from <a href="https://globaldatalab.org/shdi/">Global Development Lab</a>)</li>
<li><code>nl_mean_zscore</code>: Z-score of nighttime lights intensity, often used as a proxy for economic activity (from <a href="https://www.earthdata.nasa.gov/data/instruments/viirs">NASA VIIRS</a>)</li>
<li><code>pop_density_zscore</code>: Z-score of population density, normalizing population per unit area (from <a href="https://hub.worldpop.org/">WorldPop</a> team)</li>
<li><code>fb_pntr_18p_female</code>: Facebook penetration rate among women aged 18+ (percentage of women on Facebook in the last month relative to population) (from FB marketing API)</li>
<li><code>fb_pntr_18p_male</code>: Facebook penetration rate among men aged 18+ (percentage of women on Facebook in the last month relative to population) (from FB marketing API)</li>
</ul>
</section>
<section id="fitting-random-forest-models" class="level3">
<h3 class="anchored" data-anchor-id="fitting-random-forest-models">2.2 Fitting Random Forest Models</h3>
<p>Random forest is an ensemble learning method that improves prediction accuracy by combining multiple decision trees. At a high level, random forest works by:</p>
<ol type="1">
<li>Creating multiple decision trees using different random subsets of the training data</li>
<li>Averaging predictions across trees (for regression) to make a final prediction</li>
<li>Reducing overfitting by ensuring that individual trees don’t rely too heavily on any single feature or pattern in the data</li>
</ol>
<p>Random Forest is particularly useful for handling nonlinear relationships (like ours), high-dimensional datasets (with many features), and noisy data. We use this model as a demonstration because it is popular, easy to learn, and performs well without extensive hyperparameter tuning.</p>
<p>To fit the model, we still use the <code>tidymodel</code> <a href="https://www.tidymodels.org/">package</a>. We’ll first need to define the random forest model we want to fit. We’ll start by specifying the <em>hyperparameters</em> for our random forest model. Hyperparameters are configurable settings that control a model’s learning process; they have to be specified in advance and not learned from the data. Here’s the hyperparameters we’ll use:</p>
<ul>
<li><code>mtry = 3</code>: Three predictors are considered for each decision tree.</li>
<li><code>trees = 500</code>: The model builds 500 decision trees for better averaging.</li>
<li><code>min_n = 5</code>: Each terminal node must have at least 5 observations.</li>
</ul>
<p>We’ll set the engine to <code>Ranger</code>, which is a fast implementation of random forest. We’ll also need to specify that this is a regression problem (predicting a continuous outcome) and not a classification problem (predicting a categorical or binary outcome).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a random forest model specification</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>rf_spec <span class="ot">&lt;-</span> <span class="fu">rand_forest</span>(<span class="at">mtry =</span> <span class="dv">3</span>, <span class="at">trees =</span> <span class="dv">500</span>, <span class="at">min_n =</span> <span class="dv">5</span>) <span class="sc">%&gt;%</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"ranger"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We’ll split our data into a test and a training partition, just like we did in section 1.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">47</span>)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="do">## sgenerate train and test folds (partitions)</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>internet_subnational_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(internet_subnational, <span class="at">prop =</span> .<span class="dv">75</span>)</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="do">## split into a train-test sample </span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>internet_subnational_train <span class="ot">&lt;-</span> <span class="fu">training</span>(internet_subnational_split) </span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>internet_subnational_test <span class="ot">&lt;-</span> <span class="fu">testing</span>(internet_subnational_split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For the baseline model, we’ll start with just three features:</p>
<ol type="1">
<li>Night lights data (<code>nl_mean_zscore</code>) – a proxy for economic activity and development</li>
<li>Facebook penetration among women (<code>fb_pntr_18p_female</code>) – an indicator of digital access</li>
<li>Subnational Human Development Index for females (<code>subnational_hdi_females</code>) – subnational composite measure of health, education, and standard of living for women</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Train the Random Forest model on three features </span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>rf_fit_internet <span class="ot">&lt;-</span> rf_spec <span class="sc">%&gt;%</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(perc_used_internet_past12months_wght_age_15_to_49_wom <span class="sc">~</span> fb_pntr_18p_female <span class="sc">+</span> subnational_hdi_females <span class="sc">+</span> nl_mean_zscore,</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">data =</span> internet_subnational_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Just to help build intuition, let’s check our model performance metrics on the <strong><em>training</em></strong> data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">47</span>)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="do">## make predictions and add predictions onto training dataset</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>test_w_rf_predictions <span class="ot">&lt;-</span> <span class="fu">predict</span>(rf_fit_internet, <span class="at">new_data =</span> internet_subnational_train) <span class="sc">%&gt;%</span> </span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_cols</span>(internet_subnational_train)  <span class="co"># Add actual values for comparison</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="do">## calculate model performance metrics </span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>model_performance_metrics_training <span class="ot">&lt;-</span> test_w_rf_predictions <span class="sc">%&gt;%</span> </span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">mae =</span> <span class="fu">mae</span>(.pred, perc_used_internet_past12months_wght_age_15_to_49_wom),</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>            <span class="at">rmse =</span> <span class="fu">rmse</span>(.pred, perc_used_internet_past12months_wght_age_15_to_49_wom),</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>            <span class="at">r_squared =</span> <span class="fu">r_squared</span>(.pred, perc_used_internet_past12months_wght_age_15_to_49_wom))</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a><span class="do">## print model </span></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>model_performance_metrics_training</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
     mae   rmse r_squared
   &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt;
1 0.0414 0.0622     0.907</code></pre>
</div>
</div>
<p>In machine learning analysis, assessing model performance on the data we trained is highly misleading since these complex models usually perform extremely good on training set, but it’s probably because they just memorize patterns in the training data (overfitting).</p>
<p>Let’s check how things look when we assess model performance in the test data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">47</span>)</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="do">## make predictions and then </span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>test_w_rf_predictions_test <span class="ot">&lt;-</span> <span class="fu">predict</span>(rf_fit_internet, <span class="at">new_data =</span> internet_subnational_test) <span class="sc">%&gt;%</span> </span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_cols</span>(internet_subnational_test)  <span class="co"># Add actual values for comparison</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="do">## calculate model performance metrics </span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>model_performance_metrics_test <span class="ot">&lt;-</span> test_w_rf_predictions_test <span class="sc">%&gt;%</span> </span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">mae =</span> <span class="fu">mae</span>(.pred, perc_used_internet_past12months_wght_age_15_to_49_wom),</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>            <span class="at">rmse =</span> <span class="fu">rmse</span>(.pred, perc_used_internet_past12months_wght_age_15_to_49_wom), </span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>            <span class="at">r_squared =</span> <span class="fu">r_squared</span>(.pred, perc_used_internet_past12months_wght_age_15_to_49_wom))</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>model_performance_metrics_test</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
     mae  rmse r_squared
   &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;
1 0.0795 0.114     0.600</code></pre>
</div>
</div>
<p>Let’s visualize the difference in model performance metrics.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>model_performance_combined <span class="ot">&lt;-</span> model_performance_metrics_training <span class="sc">%&gt;%</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">set =</span> <span class="st">"training"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(model_performance_metrics_test <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">set =</span> <span class="st">"test"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>set, <span class="at">names_to =</span> <span class="st">"metric"</span>, <span class="at">values_to =</span> <span class="st">"value"</span>)</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>model_performance_combined <span class="sc">%&gt;%</span> </span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> set, <span class="at">y =</span> value, <span class="at">fill =</span> set)) <span class="sc">+</span> </span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>() <span class="sc">+</span> </span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>metric, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span> </span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_cowplot</span>() <span class="sc">+</span> </span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="tutorial2_prediction_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="fold-cross-validation" class="level3">
<h3 class="anchored" data-anchor-id="fold-cross-validation">2.3 10-fold Cross-validation</h3>
<p>As we have discussed in section 1, cross-validation is preferred than the traditional train-test splitting. Following the same procedure, we first conduct a 10-fold CV.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">47</span>)</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="do">## create folds </span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>folds_10folds <span class="ot">&lt;-</span> <span class="fu">vfold_cv</span>(internet_subnational, <span class="at">v =</span> <span class="dv">10</span>)</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>folds_10folds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>#  10-fold cross-validation 
# A tibble: 10 × 2
   splits           id    
   &lt;list&gt;           &lt;chr&gt; 
 1 &lt;split [513/57]&gt; Fold01
 2 &lt;split [513/57]&gt; Fold02
 3 &lt;split [513/57]&gt; Fold03
 4 &lt;split [513/57]&gt; Fold04
 5 &lt;split [513/57]&gt; Fold05
 6 &lt;split [513/57]&gt; Fold06
 7 &lt;split [513/57]&gt; Fold07
 8 &lt;split [513/57]&gt; Fold08
 9 &lt;split [513/57]&gt; Fold09
10 &lt;split [513/57]&gt; Fold10</code></pre>
</div>
</div>
<p>Like in the other examples, we need to define our random forest model before fitting.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">47</span>)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a random forest model specification (same as above)</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>rf_spec <span class="ot">&lt;-</span> <span class="fu">rand_forest</span>(<span class="at">mtry =</span> <span class="dv">3</span>, <span class="at">trees =</span> <span class="dv">500</span>, <span class="at">min_n =</span> <span class="dv">5</span>) <span class="sc">%&gt;%</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"ranger"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"regression"</span>)</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a><span class="do">## Define a fitting specification </span></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>rf_res_10fold <span class="ot">&lt;-</span> <span class="fu">fit_resamples</span>(</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>  rf_spec,</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>  perc_used_internet_past12months_wght_age_15_to_49_wom <span class="sc">~</span> fb_pntr_18p_female <span class="sc">+</span> subnational_hdi_females <span class="sc">+</span> nl_mean_zscore,</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">resamples =</span> folds_10folds,</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">metrics =</span> <span class="fu">metric_set</span>(yardstick<span class="sc">::</span>rmse, yardstick<span class="sc">::</span>mae, yardstick<span class="sc">::</span>rsq)</span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a><span class="do">## get error metrics  </span></span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a>error_metrics_10fold <span class="ot">&lt;-</span> <span class="fu">collect_metrics</span>(rf_res_10fold)</span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a><span class="do">## print out error metrics </span></span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a>error_metrics_10fold <span class="sc">%&gt;%</span> </span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cv_method =</span> <span class="st">"10-fold"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 7
  .metric .estimator   mean     n std_err .config              cv_method
  &lt;chr&gt;   &lt;chr&gt;       &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;                &lt;chr&gt;    
1 mae     standard   0.0919    10 0.00383 Preprocessor1_Model1 10-fold  
2 rmse    standard   0.133     10 0.00617 Preprocessor1_Model1 10-fold  
3 rsq     standard   0.656     10 0.0247  Preprocessor1_Model1 10-fold  </code></pre>
</div>
</div>
<p>Our model appears to be performing well, explaining 66% of the variation in internet adoption using only three features.</p>
</section>
<section id="leave-one-country-out-cross-validation" class="level3">
<h3 class="anchored" data-anchor-id="leave-one-country-out-cross-validation">2.4 Leave-one-country-out Cross-validation</h3>
<p>Nevertheless, we want to know how well our model would perform in countries we had no training data at all (e.g., not one of the 34 countries in our dataset). This time we would employ leave-one-country-out cross-validation rather than the standard 10-fold cross-validation. In this approach, we iteratively exclude all subnational units from one country, train the model on subnational units from the remaining countries, and then assess its performance on the excluded country’s subnational units. This method evaluates the model’s ability to generalize to unseen countries (assuming they are similar to the countries we have in our dataset).</p>
<p>Here, we’ll split into folds based on country (rather than random). Calculate MAE, RMSE, and <span class="math inline">\(R^2\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">47</span>)</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="do">## make new folds </span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>folds_loco <span class="ot">&lt;-</span> <span class="fu">group_vfold_cv</span>(internet_subnational, <span class="at">group =</span> country)</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>folds_loco</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># Group 34-fold cross-validation 
# A tibble: 34 × 2
   splits           id        
   &lt;list&gt;           &lt;chr&gt;     
 1 &lt;split [558/12]&gt; Resample01
 2 &lt;split [565/5]&gt;  Resample02
 3 &lt;split [566/4]&gt;  Resample03
 4 &lt;split [564/6]&gt;  Resample04
 5 &lt;split [560/10]&gt; Resample05
 6 &lt;split [559/11]&gt; Resample06
 7 &lt;split [510/60]&gt; Resample07
 8 &lt;split [523/47]&gt; Resample08
 9 &lt;split [561/9]&gt;  Resample09
10 &lt;split [560/10]&gt; Resample10
# ℹ 24 more rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>rf_res_loco <span class="ot">&lt;-</span> <span class="fu">fit_resamples</span>(</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  rf_spec,</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>  perc_used_internet_past12months_wght_age_15_to_49_wom <span class="sc">~</span> fb_pntr_18p_female <span class="sc">+</span> subnational_hdi_females <span class="sc">+</span> nl_mean_zscore,</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">resamples =</span> folds_loco,</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">metrics =</span> <span class="fu">metric_set</span>(yardstick<span class="sc">::</span>rmse, yardstick<span class="sc">::</span>mae, yardstick<span class="sc">::</span>rsq)</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>error_metrics_loco <span class="ot">&lt;-</span> <span class="fu">collect_metrics</span>(rf_res_loco) <span class="sc">%&gt;%</span></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cv_method =</span> <span class="st">"loco"</span>)</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>error_metrics_loco</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 7
  .metric .estimator  mean     n std_err .config              cv_method
  &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;                &lt;chr&gt;    
1 mae     standard   0.120    34  0.0156 Preprocessor1_Model1 loco     
2 rmse    standard   0.142    34  0.0161 Preprocessor1_Model1 loco     
3 rsq     standard   0.588    34  0.0514 Preprocessor1_Model1 loco     </code></pre>
</div>
</div>
<p>We find that model performance is consistently worse when using leave-one-country-out cross-validation (LOCO-CV) compared to standard 10-fold cross-validation. This is expected because LOCO-CV is a stricter and more realistic test of generalizability. In 10-fold CV, the model is trained and tested on subnational units from a shared pool, meaning each test fold likely contains units from countries that also appear in the training folds. In contrast, LOCO-CV forces the model to predict outcomes for entire countries it has never seen before. This setup simulates a real-world scenario where we apply the model to a country with no ground truth data available. If the relationship between predictors and outcomes varies across countries — due to cultural, economic, or infrastructural differences — the model may not generalize well.</p>
<p>We can also create calibration plots with our observed and predicted values for both 10-fold cross-validation and leave-one-country-out cross-validation predictions. To get predictions from CV, we use <code>control = control_resamples(save_pred = TRUE)</code> to tell tidymodel to save the predictions made during each fold of cross-validation. After fitting the model, we use <code>collect_predictions</code> function to collect predicted values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">47</span>)</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="do">##We define the entire workflow first and we don't have to repeat the feature sets in the fitting process again.</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>rf_wf <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(rf_spec) <span class="sc">%&gt;%</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_formula</span>(perc_used_internet_past12months_wght_age_15_to_49_wom <span class="sc">~</span> fb_pntr_18p_female <span class="sc">+</span> subnational_hdi_females <span class="sc">+</span> nl_mean_zscore)</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>cv_10folds_results <span class="ot">&lt;-</span> rf_wf <span class="sc">%&gt;%</span></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit_resamples</span>(</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">resamples =</span> folds_10folds,</span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">control =</span> <span class="fu">control_resamples</span>(<span class="at">save_pred =</span> <span class="cn">TRUE</span>)</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>predictions_10folds <span class="ot">&lt;-</span> <span class="fu">collect_predictions</span>(cv_10folds_results)</span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>predictions_10folds <span class="sc">%&gt;%</span></span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> perc_used_internet_past12months_wght_age_15_to_49_wom, <span class="at">y =</span> .pred)) <span class="sc">+</span></span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_cowplot</span>() <span class="sc">+</span> </span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="tutorial2_prediction_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">47</span>)</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="do">##LOCO-CV</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>cv_loco_results <span class="ot">&lt;-</span> rf_wf <span class="sc">%&gt;%</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit_resamples</span>(</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">resamples =</span> folds_loco,</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">control =</span> <span class="fu">control_resamples</span>(<span class="at">save_pred =</span> <span class="cn">TRUE</span>)</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>predictions_loco <span class="ot">&lt;-</span> <span class="fu">collect_predictions</span>(cv_loco_results)</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>predictions_loco <span class="sc">%&gt;%</span></span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> perc_used_internet_past12months_wght_age_15_to_49_wom, <span class="at">y =</span> .pred)) <span class="sc">+</span></span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_cowplot</span>() <span class="sc">+</span> </span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="tutorial2_prediction_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Similar to leave-one-country-out cross-validation (LOCO-CV), we also implement leave-one-year-out cross-validation (LOYO-CV). In this setup, the model is trained on data from all years except one, and then tested on the held-out year. This process is repeated for each year in the dataset. This helps us to evaluate the model’s ability to generalize across time.</p>
</section>
<section id="exercise-2" class="level3">
<h3 class="anchored" data-anchor-id="exercise-2">2.5 Exercise 2</h3>
<ol type="1">
<li>Construct online, offline and combined predicting models for female internet adoption using random forest models. Use LOCO-CV method to evaluate model performance. Does the result align with your expectations?</li>
<li>Using your best-performing models, try adjusting the hyperparameters and evaluate the results using LOCO-CV. Compare the change in model performance due to hyperparameter tuning with the change in performance across different feature sets (e.g., online, offline, combined). Which factor has a greater impact on model performance?</li>
</ol>
</section>
<section id="bonus-superlearner" class="level3">
<h3 class="anchored" data-anchor-id="bonus-superlearner">Bonus: Superlearner</h3>
<p>While we use random forest to generate subnational nowcasts in the DGG project, it is not the only algorithm we rely on. Instead, we use an ensemble Superlearner—also known as weighted ensembling or stacking—which combines predictions from multiple machine learning algorithms into a single, optimized model. The motivation behind ensemble Superlearning is that a well-calibrated weighted combination of diverse algorithms can often outperform any single model. By leveraging the strengths of different methods and smoothing out their individual weaknesses, the Superlearner helps reduce the risk of overfitting and improves generalizability. To construct the ensemble, the algorithm uses a cross-validation procedure to determine the optimal weights for each learner—selecting the combination that delivers the best out-of-sample performance. In our implementation, the Superlearner draws from a diverse library of widely-used machine learning models, including Random Forest, Generalized Linear Models (GLM), Gradient Boosting Machines (GBM), Lasso Regression, Elastic Net Regression, Polynomial Splines Regression, Ridge Regression, and Extreme Gradient Boosting (XGBoost).</p>
<p>If you’re interested in replicating this approach or exploring the full pipeline, feel free to visit our <a href="https://github.com/OxfordDemSci/dgg_subnational">GitHub repository</a>.</p>
</section>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>